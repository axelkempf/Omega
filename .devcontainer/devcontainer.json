// Dev Container Configuration for Omega Trading System
// Task-ID: P4-10 | Phase: 4 â€“ Build-System
//
// This configuration provides a complete development environment with:
// - Python 3.12 with all dev dependencies
// - Rust toolchain (1.92+) with Maturin
// - Julia 1.12 with required packages
// - Pre-configured VS Code extensions
//
// Usage:
//   1. Install "Dev Containers" extension in VS Code
//   2. Open command palette: "Dev Containers: Reopen in Container"
//   3. Wait for container build and setup to complete
//
// Documentation: https://containers.dev/

{
	"name": "Omega Trading System",
	"build": {
		"dockerfile": "Dockerfile",
		"context": "..",
		"args": {
			"PYTHON_VERSION": "3.12",
			"RUST_VERSION": "1.92.0",
			"JULIA_VERSION": "1.12"
		}
	},

	// Container user settings
	"remoteUser": "vscode",
	"containerUser": "vscode",

	// Features to add to the dev container
	"features": {
		// Git and GitHub CLI
		"ghcr.io/devcontainers/features/github-cli:1": {},
		// Common utilities (jq, curl, wget, etc.)
		"ghcr.io/devcontainers/features/common-utils:2": {
			"installZsh": true,
			"installOhMyZsh": true,
			"upgradePackages": true
		}
	},

	// VS Code customizations
	"customizations": {
		"vscode": {
			// Extensions to install
			"extensions": [
				// Python
				"ms-python.python",
				"ms-python.vscode-pylance",
				"ms-python.black-formatter",
				"ms-python.isort",
				"ms-python.mypy-type-checker",
				"ms-python.flake8",
				// Rust
				"rust-lang.rust-analyzer",
				"tamasfe.even-better-toml",
				"serayuzgur.crates",
				"vadimcn.vscode-lldb",
				// Julia
				"julialang.language-julia",
				// General Development
				"eamodio.gitlens",
				"GitHub.copilot",
				"GitHub.copilot-chat",
				"usernamehw.errorlens",
				"streetsidesoftware.code-spell-checker",
				// File Support
				"redhat.vscode-yaml",
				"mechatroner.rainbow-csv",
				"yzhang.markdown-all-in-one",
				// Testing
				"ms-vscode.test-adapter-converter",
				"hbenl.vscode-test-explorer"
			],
			// VS Code settings
			"settings": {
				// Terminal
				"terminal.integrated.defaultProfile.linux": "zsh",
				
				// Python settings
				"python.defaultInterpreterPath": "/usr/local/bin/python",
				"python.analysis.typeCheckingMode": "basic",
				"python.analysis.autoImportCompletions": true,
				"[python]": {
					"editor.defaultFormatter": "ms-python.black-formatter",
					"editor.formatOnSave": true,
					"editor.codeActionsOnSave": {
						"source.organizeImports": "explicit"
					}
				},
				"isort.args": ["--profile", "black"],
				"mypy-type-checker.args": ["--config-file=pyproject.toml"],
				
				// Rust settings
				"rust-analyzer.cargo.features": "all",
				"rust-analyzer.checkOnSave.command": "clippy",
				"rust-analyzer.checkOnSave.extraArgs": ["--", "-W", "clippy::pedantic"],
				"[rust]": {
					"editor.defaultFormatter": "rust-lang.rust-analyzer",
					"editor.formatOnSave": true
				},
				
				// Julia settings
				"julia.executablePath": "/usr/local/julia/bin/julia",
				"julia.environmentPath": "${workspaceFolder}/src/julia_modules/omega_julia",
				
				// General editor settings
				"editor.rulers": [88, 120],
				"editor.tabSize": 4,
				"editor.insertSpaces": true,
				"files.trimTrailingWhitespace": true,
				"files.insertFinalNewline": true,
				
				// Git settings
				"git.autofetch": true,
				"git.enableSmartCommit": true
			}
		}
	},

	// Port forwarding for FastAPI server
	"forwardPorts": [8000],
	"portsAttributes": {
		"8000": {
			"label": "FastAPI UI",
			"onAutoForward": "notify"
		}
	},

	// Post-create commands
	"postCreateCommand": "bash .devcontainer/post-create.sh",

	// Post-start commands (run every time container starts)
	"postStartCommand": "echo 'ðŸš€ Omega dev container ready!'",

	// Environment variables
	"containerEnv": {
		"PYTHONDONTWRITEBYTECODE": "1",
		"PYTHONUNBUFFERED": "1",
		"CARGO_HOME": "/home/vscode/.cargo",
		"RUSTUP_HOME": "/home/vscode/.rustup",
		"JULIA_DEPOT_PATH": "/home/vscode/.julia",
		// PythonCall configuration for Julia
		"JULIA_PYTHONCALL_EXE": "/usr/local/bin/python"
	},

	// Mount points
	"mounts": [
		// Persist Cargo cache
		"source=omega-cargo-cache,target=/home/vscode/.cargo,type=volume",
		// Persist Julia packages
		"source=omega-julia-cache,target=/home/vscode/.julia,type=volume",
		// Persist pip cache
		"source=omega-pip-cache,target=/home/vscode/.cache/pip,type=volume"
	],

	// Run arguments
	"runArgs": [
		// Enable ptrace for debugging
		"--cap-add=SYS_PTRACE",
		"--security-opt", "seccomp=unconfined"
	],

	// Host requirements
	"hostRequirements": {
		"cpus": 4,
		"memory": "8gb",
		"storage": "32gb"
	}
}
