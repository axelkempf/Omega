name: omega-v2-ci

# Note: docs-only changes are skipped via paths-ignore.

on:
  pull_request:
    paths-ignore:
      - "docs/**"
      - "**/*.md"
  push:
    branches: ["main"]
    paths-ignore:
      - "docs/**"
      - "**/*.md"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  python_precommit:
    name: python-precommit
    runs-on: ubuntu-latest
    if: ${{ hashFiles('rust_core/**') != '' || hashFiles('python/bt/**') != '' }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
      - name: Install pre-commit
        run: |
          python -m pip install -U pip
          python -m pip install pre-commit
      - name: Run pre-commit (V2 files only)
        shell: bash
        run: |
          set -euo pipefail
          files="$(git ls-files 'rust_core/**' 'python/bt/**' || true)"
          if [ -z "${files}" ]; then
            echo "No V2 files found; skipping pre-commit."
            exit 0
          fi
          echo "${files}" | tr ' ' '\n'
          pre-commit run --files ${files}

  python_tests:
    name: python-tests
    runs-on: ubuntu-latest
    if: ${{ hashFiles('python/bt/tests/**/*.py') != '' }}
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.12", "3.13"]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"
      - name: Install dependencies
        run: |
          python -m pip install -U pip
          python -m pip install -e ".[dev]"
      - name: Run V2 Python tests
        run: pytest python/bt/tests -q

  rust_checks:
    name: rust-checks
    runs-on: ubuntu-latest
    if: ${{ hashFiles('rust_core/Cargo.toml') != '' }}
    steps:
      - uses: actions/checkout@v4
      - name: Rust fmt + clippy + test
        shell: bash
        run: |
          set -euo pipefail
          cd rust_core
          rustup component add rustfmt clippy
          cargo fmt --all -- --check
          cargo clippy --all-targets -- -D warnings
          cargo test --all

  golden_smoke:
    name: golden-smoke
    runs-on: ubuntu-latest
    if: ${{ hashFiles('python/bt/tests/test_golden.py') != '' }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
      - name: Install dependencies
        run: |
          python -m pip install -U pip
          python -m pip install -e ".[dev]"
      - name: Run golden-smoke
        run: pytest python/bt/tests/test_golden.py -k "smoke" -q
