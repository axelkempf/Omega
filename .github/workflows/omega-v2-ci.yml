name: omega-v2-ci

# Note: docs-only changes are skipped via paths-ignore.

on:
  pull_request:
    paths-ignore:
      - "docs/**"
      - "**/*.md"
  push:
    branches: ["main"]
    paths-ignore:
      - "docs/**"
      - "**/*.md"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  python_precommit:
    name: python-precommit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - name: Install pre-commit
        run: |
          python -m pip install -U pip
          python -m pip install pre-commit
      - name: Run pre-commit
        run: pre-commit run -a

  rust_checks:
    name: rust-checks
    runs-on: ubuntu-latest
    env:
      PYTHON: python3
      PYO3_PYTHON: python3
      PYTHONPATH: ${{ github.workspace }}/src:${{ github.workspace }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
      - name: Install Python dependencies for parity tests
        run: pip install numpy pandas
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - name: Rust fmt + clippy + test
        shell: bash
        run: |
          set -euo pipefail
          cd rust_core
          cargo fmt --all -- --check
          cargo clippy --all-targets -- -D warnings
          cargo test --all

  python_tests:
    name: python-tests
    runs-on: ubuntu-latest
    env:
      PYO3_PYTHON: python3
      PYTHONPATH: ${{ github.workspace }}/src:${{ github.workspace }}
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.12"]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"
      - uses: dtolnay/rust-toolchain@stable
      - name: Install dependencies
        run: |
          python -m pip install -U pip
          python -m pip install -e ".[dev]"
          python -m pip install maturin
      - name: Build and install omega_bt
        run: |
          maturin build --release --out dist -m rust_core/crates/ffi/Cargo.toml
          pip install dist/*.whl --force-reinstall
      - name: Run V2 Python tests
        env:
          OMEGA_DATA_PARQUET_ROOT: python/tests/fixtures/data/parquet
        run: pytest python/tests -q

  golden_smoke:
    name: golden-smoke
    runs-on: ubuntu-latest
    env:
      PYO3_PYTHON: python3
      PYTHONPATH: ${{ github.workspace }}/src:${{ github.workspace }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
      - uses: dtolnay/rust-toolchain@stable
      - name: Install dependencies
        run: |
          python -m pip install -U pip
          python -m pip install -e ".[dev]"
          python -m pip install maturin
      - name: Build and install omega_bt
        run: |
          maturin build --release --out dist -m rust_core/crates/ffi/Cargo.toml
          pip install dist/*.whl --force-reinstall
      - name: Run golden-smoke
        env:
          OMEGA_DATA_PARQUET_ROOT: python/tests/fixtures/data/parquet
        run: pytest python/tests/test_golden.py -k "smoke" -q

  build_wheels:
    name: build-wheels
    runs-on: ${{ matrix.os }}
    env:
      PYO3_PYTHON: python3
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-13, macos-14]
        python-version: ["3.12"]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - uses: PyO3/maturin-action@v1
        with:
          command: build
          args: --release --out dist -m rust_core/crates/ffi/Cargo.toml
      - uses: actions/upload-artifact@v4
        with:
          name: omega-v2-wheels-${{ matrix.os }}-py${{ matrix.python-version }}
          path: dist/*

  security_dependency_review:
    name: security-dependency-review
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/dependency-review-action@v4

  security_audit:
    name: security-audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
      - name: Install pip-audit
        run: |
          python -m pip install -U pip
          python -m pip install -e ".[dev]"
          python -m pip install pip-audit
      - name: Run pip-audit
        run: pip-audit
      - uses: dtolnay/rust-toolchain@stable
      - name: Install cargo-audit
        run: cargo install cargo-audit
      - name: Run cargo-audit
        shell: bash
        run: |
          set -euo pipefail
          if [ -f rust_core/Cargo.lock ]; then
            cd rust_core
            cargo audit
          else
            echo "Cargo.lock not found; skipping cargo audit."
          fi

  security_codeql:
    name: security-codeql
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4
      - uses: github/codeql-action/init@v3
        with:
          languages: python,rust
          build-mode: none
      - uses: dtolnay/rust-toolchain@stable
      - name: Build Rust workspace
        shell: bash
        run: |
          set -euo pipefail
          if [ -f rust_core/Cargo.toml ]; then
            cd rust_core
            cargo build --workspace
          else
            echo "rust_core missing; skipping build."
          fi
      - uses: github/codeql-action/analyze@v3
