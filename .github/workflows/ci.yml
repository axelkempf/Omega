name: CI
on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'pyproject.toml'
      - '.github/workflows/ci.yml'
  pull_request:
    paths:
      - 'src/**'
      - 'tests/**'
      - 'pyproject.toml'
      - '.github/workflows/ci.yml'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.12'
  PIP_DISABLE_PIP_VERSION_CHECK: 1
  PYTHONDONTWRITEBYTECODE: 1

permissions:
  contents: read

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: pyproject.toml

      - name: Install linting tools
        run: pip install black isort flake8

      - name: Check formatting (black)
        run: black --check --diff src/ tests/

      - name: Check imports (isort)
        run: isort --check-only --diff src/ tests/

      - name: Lint (flake8 - critical only)
        run: flake8 src/ tests/ --max-line-length=120 --extend-ignore=E203,W503,F824 --select=E9,F63,F7,F82

  docs-lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: pyproject.toml

      - name: Install pytest
        run: pip install pytest

      - name: Validate docs references (hard gate)
        run: pytest -q tests/test_docs_reference_linter.py

  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: pyproject.toml

      - name: Install security tools and dependencies
        run: |
          pip install bandit pip-audit
          pip install -e .[dev,analysis]

      - name: Security scan with bandit
        run: bandit -r src/ -ll -ii --skip B101

      - name: Audit dependencies with pip-audit
        run: pip-audit --ignore-vuln PYSEC-2024-48

  type-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: pyproject.toml

      - name: Cache mypy
        uses: actions/cache@v4
        with:
          path: .mypy_cache
          key: mypy-${{ runner.os }}-${{ hashFiles('src/**/*.py') }}
          restore-keys: mypy-${{ runner.os }}-

      - name: Install type checking tools
        run: |
          pip install mypy types-PyYAML types-requests types-python-dateutil pandas-stubs
          pip install -e .[dev]
      - name: Type check - strict (base modules)
        run: |
          mypy src/strategies/_base/ \
               src/strategies/_template/ \
               src/ui_engine/models.py \
               --ignore-missing-imports \
               --strict \
               --no-error-summary
      - name: Type check - strict (shared modules - migration critical)
        run: |
          mypy src/shared/ \
               --ignore-missing-imports \
               --strict \
               --no-error-summary
      - name: Type check - strict (backtest_engine migration modules)
        run: |
          mypy src/backtest_engine/core/ \
               src/backtest_engine/config/ \
               src/backtest_engine/optimizer/ \
               src/backtest_engine/rating/ \
               --ignore-missing-imports \
               --strict \
               --no-error-summary
      - name: Type coverage report
        run: python tools/type_coverage.py

  test:
    runs-on: ubuntu-latest
    needs: [lint]
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: pyproject.toml

      - name: Cache pytest
        uses: actions/cache@v4
        with:
          path: .pytest_cache
          key: pytest-${{ runner.os }}-${{ hashFiles('tests/**/*.py') }}
          restore-keys: pytest-${{ runner.os }}-

      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost

      - name: Install dependencies
        run: |
          pip install -e .[dev]
          pip install pytest-cov pytest-xdist

      - name: Run tests with coverage (parallel)
        run: pytest -q -m "not integration" -n auto --cov=src --cov-report=xml --cov-report=term-missing

  integration-tests:
    runs-on: ubuntu-latest
    needs: [lint]
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: pyproject.toml

      - name: Install dependencies
        run: pip install -e .[dev] pytest-cov

      - name: Trading safety suite (marker)
        run: pytest -q -m "trading_safety" tests/integration --cov=src --cov-report=term-missing --cov-report=xml

      - name: Integration suite (remaining)
        run: pytest -q -m "integration and not trading_safety" tests/integration --cov=src --cov-append --cov-report=term-missing --cov-report=xml

  # ============================================================================
  # CI Summary Job
  # ============================================================================
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint, docs-lint, security, type-check, test, integration-tests]
    if: always()
    steps:
      - name: Generate CI Summary
        run: |
          echo "## ðŸ” CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docs Lint | ${{ needs.docs-lint.result == 'success' && 'âœ…' || needs.docs-lint.result == 'skipped' && 'â­ï¸' || 'âŒ' }} ${{ needs.docs-lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Type-Check | ${{ needs.type-check.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.type-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test | ${{ needs.test.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration | ${{ needs.integration-tests.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** [${{ github.workflow }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY

      - name: Check for failures
        if: |
          needs.lint.result == 'failure' ||
          needs.security.result == 'failure' ||
          needs.type-check.result == 'failure' ||
          needs.test.result == 'failure' ||
          needs.integration-tests.result == 'failure'
        run: |
          echo "::error::One or more critical CI jobs failed"
          exit 1
